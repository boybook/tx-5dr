<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TX-5DR å¯åŠ¨æ—¥å¿—</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft YaHei", sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #e0e0e0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* macOS æ‹–åŠ¨æ¡æ ·å¼ */
    .drag-bar {
      -webkit-app-region: drag;
      height: 20px;
      width: 100%;
      background: transparent;
      position: absolute;
      top: 0;
      left: 0;
      z-index: 1000;
    }

    .header {
      background: rgba(255, 69, 58, 0.1);
      border-bottom: 2px solid rgba(255, 69, 58, 0.3);
      padding: 24px 32px;
      flex-shrink: 0;
      display: none; /* é»˜è®¤éšè— */
    }

    .header h1 {
      font-size: 24px;
      font-weight: 600;
      color: #ff453a;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header .icon {
      font-size: 32px;
    }

    .header .subtitle {
      font-size: 14px;
      color: #a0a0a0;
      margin-left: 44px;
    }

    .error-type {
      background: rgba(255, 69, 58, 0.15);
      border-left: 4px solid #ff453a;
      padding: 12px 16px;
      margin: 16px 32px 0;
      border-radius: 4px;
      font-size: 14px;
      color: #ffb3b3;
      flex-shrink: 0;
      display: none; /* é»˜è®¤éšè— */
    }

    .log-container {
      flex: 1;
      margin: 24px 32px;
      background: #0d1117;
      border: 1px solid #30363d;
      border-radius: 8px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
    }

    .log-header {
      background: #161b22;
      padding: 12px 16px;
      border-bottom: 1px solid #30363d;
      font-size: 13px;
      color: #8b949e;
      font-weight: 500;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .log-output {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      font-family: "SF Mono", Monaco, "Cascadia Code", "Roboto Mono", Consolas, monospace;
      font-size: 13px;
      line-height: 1.6;
      color: #c9d1d9;
    }

    .log-line {
      margin-bottom: 4px;
      word-wrap: break-word;
      white-space: pre-wrap;
    }

    .log-line.error {
      color: #ff7b72;
      background: rgba(255, 123, 114, 0.1);
      padding: 2px 4px;
      border-radius: 3px;
    }

    .log-line.warning {
      color: #ffd700;
    }

    .log-line.info {
      color: #00bfff;
    }

    .suggestions {
      margin: 16px 32px;
      display: none; /* é»˜è®¤éšè— */
    }

    .suggestions h3 {
      margin-bottom: 8px;
      color: #ff6b6b;
    }

    .suggestion-item {
      margin-bottom: 12px;
      padding: 10px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 6px;
    }

    .suggestion-title {
      font-weight: bold;
      margin-bottom: 4px;
    }

    .suggestion-text {
      font-size: 13px;
      line-height: 1.5;
    }

    .suggestion-text code {
      background: rgba(0, 0, 0, 0.3);
      padding: 2px 4px;
      border-radius: 3px;
      font-size: 12px;
    }
  </style>
</head>
<body>
<!-- macOS æ‹–åŠ¨æ¡ -->
<div class="drag-bar" id="dragBar"></div>

<div class="header" id="headerSection">
  <h1><span class="icon">âš ï¸</span> TX-5DR å¯åŠ¨å¤±è´¥</h1>
  <p class="subtitle">è¯·æŸ¥çœ‹ä¸‹æ–¹æ—¥å¿—ä»¥äº†è§£è¯¦ç»†ä¿¡æ¯</p>
</div>

<div class="error-type" id="errorTypeSection"></div>

<div class="log-container">
  <div class="log-header">
    <span>å¯åŠ¨æ—¥å¿—</span>
  </div>
  <div class="log-output" id="logOutput"></div>
</div>

<div class="suggestions" id="suggestionsSection">
  <h3>æ’æŸ¥å»ºè®®</h3>
  <div id="suggestionsContent"></div>
</div>

<script>
  const logOutput = document.getElementById('logOutput');
  const errorTypeSection = document.getElementById('errorTypeSection');
  const suggestionsSection = document.getElementById('suggestionsSection');
  const headerSection = document.getElementById('headerSection');
  const dragBar = document.getElementById('dragBar');

  let isMacOS = false;

  // æ£€æµ‹æ˜¯å¦ä¸º macOS
  if (navigator.userAgent.indexOf('Mac') !== -1) {
    isMacOS = true;
    dragBar.style.display = 'block';
  } else {
    dragBar.style.display = 'none';
  }

  let autoScroll = true;

  function addLogLine(log, type) {
    const logElement = document.createElement('div');
    logElement.className = `log-line log-line-${type}`;
    logElement.textContent = log;
    logOutput.appendChild(logElement);

    // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
    if (autoScroll) {
      logOutput.scrollTop = logOutput.scrollHeight;
    }
  }

  function classifyLogLine(log) {
    if (log.includes('error') || log.includes('Error') || log.includes('ERROR')) {
      return 'error';
    } else if (log.includes('warn') || log.includes('Warn') || log.includes('WARN')) {
      return 'warning';
    } else if (log.includes('info') || log.includes('Info') || log.includes('INFO')) {
      return 'info';
    } else {
      return 'normal';
    }
  }

  function renderSuggestions(errorType) {
    const suggestions = {
      'PORT_IN_USE': [
        { title: 'ç«¯å£å ç”¨', text: 'è¯·æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–ç¨‹åºå ç”¨äº†è¯¥ç«¯å£' },
        { title: 'æ›´æ¢ç«¯å£', text: 'ä¿®æ”¹é…ç½®æ–‡ä»¶ä¸­çš„ç«¯å£å·' }
      ],
      'MODULE_NOT_FOUND': [
        { title: 'å®‰è£…ä¾èµ–', text: 'è¿è¡Œ npm install å®‰è£…ç¼ºå¤±çš„æ¨¡å—' },
        { title: 'æ£€æŸ¥ç‰ˆæœ¬', text: 'ç¡®è®¤ Node.js ç‰ˆæœ¬å…¼å®¹æ€§' }
      ],
      'PERMISSION_DENIED': [
        { title: 'æƒé™è®¾ç½®', text: 'æ£€æŸ¥åº”ç”¨æ˜¯å¦æœ‰è¶³å¤Ÿçš„è®¿é—®æƒé™' },
        { title: 'è¿è¡Œæ–¹å¼', text: 'å°è¯•ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œ' }
      ],
      'TIMEOUT': [
        { title: 'ç­‰å¾…æ—¶é—´', text: 'å¢åŠ å¯åŠ¨è¶…æ—¶æ—¶é—´é…ç½®' },
        { title: 'èµ„æºæ£€æŸ¥', text: 'ç¡®è®¤ç³»ç»Ÿèµ„æºæ˜¯å¦å……è¶³' }
      ],
      'CRASH': [
        { title: 'æŸ¥çœ‹æ—¥å¿—', text: 'æ£€æŸ¥è¯¦ç»†çš„é”™è¯¯æ—¥å¿—ä¿¡æ¯' },
        { title: 'é‡å¯æœåŠ¡', text: 'é‡å¯åº”ç”¨æœåŠ¡è¿›ç¨‹' }
      ],
      'UNKNOWN': [
        { title: 'è¯¦ç»†æŸ¥çœ‹', text: 'æ»šåŠ¨ä¸Šæ–¹æ—¥å¿—æŸ¥çœ‹å®Œæ•´é”™è¯¯ä¿¡æ¯' },
        { title: 'è”ç³»æ”¯æŒ', text: 'å¦‚æœé—®é¢˜æŒç»­å­˜åœ¨,è¯·å°†æ—¥å¿—ä¿¡æ¯åé¦ˆç»™å¼€å‘å›¢é˜Ÿ' }
      ]
    };

    const config = suggestions[errorType] || suggestions['UNKNOWN'];

    const suggestionsContent = document.getElementById('suggestionsContent');
    suggestionsContent.innerHTML = config.map(item => `
        <div class="suggestion-item">
          <div class="suggestion-title">${item.title}</div>
          <div class="suggestion-text">${item.text}</div>
        </div>
      `).join('');
  }

  function showErrorSection(errorType, message) {
    // æ˜¾ç¤ºæ ‡é¢˜åŒºåŸŸ
    headerSection.style.display = 'block';

    // æ˜¾ç¤ºé”™è¯¯ç±»å‹å’Œå»ºè®®åŒºåŸŸ
    errorTypeSection.textContent = message;
    errorTypeSection.style.display = 'block';
    suggestionsSection.style.display = 'block';

    renderSuggestions(errorType);
  }

  if (window.electronAPI) {
    window.electronAPI.onLogUpdate((log) => {
      const type = classifyLogLine(log);
      addLogLine(log, type);
    });

    window.electronAPI.getErrorType().then(errorType => {
      const errorMessages = {
        'PORT_IN_USE': 'ğŸ”´ ç«¯å£å ç”¨ - æœåŠ¡ç«¯å£å·²è¢«å…¶ä»–ç¨‹åºä½¿ç”¨',
        'MODULE_NOT_FOUND': 'ğŸ“¦ ä¾èµ–ç¼ºå¤± - ç¼ºå°‘å¿…è¦çš„ Node.js æ¨¡å—',
        'PERMISSION_DENIED': 'ğŸ”’ æƒé™ä¸è¶³ - åº”ç”¨æ²¡æœ‰è¶³å¤Ÿçš„è®¿é—®æƒé™',
        'TIMEOUT': 'â±ï¸ å¯åŠ¨è¶…æ—¶ - æœåŠ¡æœªèƒ½åœ¨é¢„æœŸæ—¶é—´å†…å¯åŠ¨',
        'CRASH': 'ğŸ’¥ è¿›ç¨‹å´©æºƒ - å­è¿›ç¨‹æ„å¤–é€€å‡º',
        'UNKNOWN': 'â“ æœªçŸ¥é”™è¯¯ - è¯·æŸ¥çœ‹æ—¥å¿—è¯¦æƒ…'
      };

      showErrorSection(errorType, errorMessages[errorType] || errorMessages['UNKNOWN']);
    });

    window.electronAPI.getStartupLogs().then(logs => {
      logs.forEach(log => {
        const type = classifyLogLine(log);
        addLogLine(log, type);
      });
    });
  }

  logOutput.addEventListener('scroll', () => {
    const isAtBottom = logOutput.scrollHeight - logOutput.scrollTop <= logOutput.clientHeight + 50;
    autoScroll = isAtBottom;
  });
</script>
</body>
</html>
