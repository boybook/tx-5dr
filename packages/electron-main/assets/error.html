<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TX-5DR 启动日志</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "SF Mono", Monaco, "Cascadia Code", "Roboto Mono", Consolas, monospace;
      background: #000;
      color: #c9d1d9;
      height: 100vh;
      overflow: hidden;
    }

    .drag-bar {
      -webkit-app-region: drag;
      height: 40px;
      width: 100%;
      background: transparent;
      position: absolute;
      top: 0;
      left: 0;
      z-index: 1000;
    }

    .log-container {
      height: 100vh;
      display: flex;
      flex-direction: column;
      background: #0a0a0a;
    }

    /* macOS 顶部 padding，为窗口控制按钮留出空间 */
    body.macos .log-container {
      padding-top: 24px;
    }

    .error-banner {
      margin: 16px;
      padding: 12px 16px;
      background: rgba(255, 69, 58, 0.15);
      border-left: 3px solid #ff453a;
      color: #ffb3b3;
      font-size: 13px;
      display: none;
    }

    .log-output {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      font-size: 13px;
      line-height: 1.6;
    }

    .log-line {
      margin-bottom: 4px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .log-line-error {
      color: #ff7b72;
    }

    .log-line-warning {
      color: #ffd700;
    }

    .log-line-info {
      color: #58a6ff;
    }
  </style>
</head>
<body>
<div class="drag-bar" id="dragBar"></div>
<div class="log-container">
  <div class="error-banner" id="errorBanner"></div>
  <div class="log-output" id="logOutput"></div>
</div>

<script>
  const logOutput = document.getElementById('logOutput');
  const errorBanner = document.getElementById('errorBanner');
  const dragBar = document.getElementById('dragBar');

  // 检测 macOS 并添加相应的样式
  const isMac = navigator.userAgent.indexOf('Mac') !== -1;
  if (isMac) {
    document.body.classList.add('macos');
  } else {
    dragBar.style.display = 'none';
  }

  let autoScroll = true;

  function addLogLine(log, type) {
    const div = document.createElement('div');
    div.className = `log-line log-line-${type}`;
    div.textContent = log;
    logOutput.appendChild(div);

    if (autoScroll) {
      logOutput.scrollTop = logOutput.scrollHeight;
    }
  }

  function classifyLogLine(log) {
    const lower = log.toLowerCase();
    if (lower.includes('error')) return 'error';
    if (lower.includes('warn')) return 'warning';
    if (lower.includes('info')) return 'info';
    return 'normal';
  }

  function showError(errorType) {
    // 只显示明确的关键错误，忽略未知错误
    const messages = {
      'PORT_IN_USE': '端口占用',
      'MODULE_NOT_FOUND': '依赖缺失',
      'PERMISSION_DENIED': '权限不足',
      'TIMEOUT': '启动超时',
      'CRASH': '进程崩溃'
    };

    // 只有在已知错误列表中才显示错误横幅
    if (messages[errorType]) {
      errorBanner.textContent = messages[errorType];
      errorBanner.style.display = 'block';
    }
  }

  if (window.electronAPI) {
    // 监听日志更新
    window.electronAPI.onLogUpdate((log) => {
      addLogLine(log, classifyLogLine(log));
    });

    // 监听实时错误检测
    window.electronAPI.onErrorDetected((errorType) => {
      showError(errorType);
    });

    // 获取初始错误状态
    window.electronAPI.getErrorType().then(errorType => {
      if (errorType) {
        showError(errorType);
      }
    });

    // 获取初始日志
    window.electronAPI.getStartupLogs().then(logs => {
      logs.forEach(log => addLogLine(log, classifyLogLine(log)));
    });
  }

  logOutput.addEventListener('scroll', () => {
    autoScroll = logOutput.scrollHeight - logOutput.scrollTop <= logOutput.clientHeight + 50;
  });
</script>
</body>
</html>
